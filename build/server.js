(function(){function eb(a,b){for(var c=-1,d=b.length>>>0;++c<d;)if(a===b[c])return!0;return!1}var a,b,c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,$,_,aa,ba,ca,da,ea,fa,ga,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,sa,ta,ua,va,wa,xa,ya,za,Aa,Ba,Ca,Da,Ea,Fa,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,Qa,Ra,Sa,Ta,Ua,Va,Wa,Xa,Ya,Za,$a,_a,ab,bb,cb,db;if(a=require("./conf"),b=require("async"),c=require("lodash"),require("colors"),e=require("ms"),f=require("moment"),g=require("moment-range"),h=require("nodemailer"),i=require("btce-deal"),j=require("node-telegram-bot-api"),k=require("ta-lib"),f=g.extendMoment(f),!a.tokenTelegram)return void console.log("There is no token Telegram!".red);l=new i.Public(a.host),m=new i.Trade(a.key,a.secret,a.host),n=new j(a.tokenTelegram,{polling:!0}),o=function(b,c){b.length>4096&&(b="Слишком много информации для отображения"),n.sendMessage(a.myChatId,b,c)},p=h.createTransport(a.email),q=function(a,b){return p.sendMail(a,b)},r=function(){return a.tradeCurrency.pair.replace("_","/").toUpperCase()},s=function(b){return{from:a.email.auth.user,to:a.email.reportEmail,subject:"Error Script Trader",text:"time: "+(new Date).toString()+"\nPair: "+r()+"\n\nmessage: "+b+"\n\n---"}},t=function(){return(new Date).toLocaleTimeString("en-US",{timeZone:a.timeZone,hour12:!1})},u=function(){return Math.round((new Date).getTime()/1e3)},v=function(a,b){return u()-a>=60*b},w=!0,x=null,y={name:0,nameTwo:0},z=u(),A=u(),B=u(),C=a.timeUpdateAutoSettings,D=!0,E=!1,F=0,G={all:null,buy:null,sell:null},H={extra:0,buy:0,sell:0},I=0,J=0,K=0,L=0,M=0,N=!1,O=0,P=0,Q=0,R=0,S=[],T=[],U="all",V=!1,W={ask:0,bid:0},X="normal",Y=0,Z=0,$=0,_=0,aa=0,ba=!1,ca=!1,da=!1,ea=null!=(fa=a.notificationPair)?fa.toLowerCase().replace(/\//g,"_").split(/\s*,\s*/):void 0,ga={spread:!1,eco:!1},ha={status:!1,interval:!1},ia={status:!1,interval:!1},ja={btc:"฿",usd:"$",eur:"€",rur:"₽",ltc:"L"},ka="-----------------------------------",la=function(a,b){var c,d,e;return null!=b&&(c=b),c||(c=a>=1?["минута","минуты","минут"]:["секунда","секунды","секунд"],a=a<1?60*a:a),d=[2,0,1,1,1,2],e=c[a%100>4&&a%100<20?2:d[a%10<5?a%10:5]],a+" "+e},ma=function(a,b){return null==b&&(b=3),+(+a).toFixed(b)},na=function(a,b){return b>0?+(100*a/b).toFixed(1):0},oa=function(a,b){return null==b&&(b=Y),ma(a/+("1e"+b),b)},pa=function(a,b){return null==b&&(b=Y),ma(a*+("1e"+b),b)},qa=function(a,b,c){var d,e,f;return null==b&&(b=0),null==c&&(c=Y),d=a/100*$*2,e=Math.ceil(d*+("1e"+c))/+("1e"+c),f=e+e/100*b,ma(f,c)},ra=function(a,b){return ma(a/100*b,Y)},sa=function(a,b){return ma(100*a/b,Y)},ta=function(a,b){return a/b*.998},ua=function(a,b){return a*b*.998},va=function(){a.bbands&&R>0&&(T.push(R),T.length>30&&T.splice(0,1))},wa=function(a,b){var c,d,e;return null==b&&(b=1),b=a<.001?1:b,c=a.toString().split(".")[0],d=a.toString().split(".")[1].length,e=c>0?c>1e4?+("1e"+(d+1)):c>1e3?+("1e"+d):c>100?+("1e"+(d-1)):c>10?+("1e"+(d-2)):d>3?+("1e"+(d-3)):1:1,b*=e,ma(b/+("1e"+d),d)},xa=function(b,d,e){var f,g,h,i,j,l,m,n,p,q,s,v,x,y,z,K,L,M,N,O,ca,ea,fa,ga,ha,ia,ja,la,oa,ta,ua,va,xa,ya;if(B=u(),G={buy:null,sell:null},f=b.toString().length,g=d.toString().length,i={},i[f+""]=b,i[g+""]=d,h=i,j=Math.max(f,g),l=h[j],Y=Oa.pairs[a.tradeCurrency.pair].decimal_places,_=Oa.pairs[a.tradeCurrency.pair].min_amount,Z=Oa.pairs[a.tradeCurrency.pair].min_price,$=Oa.pairs[a.tradeCurrency.pair].fee,m=ma(b-d,Y),n=qa(l,200),a.dynamicSettingsTime&&(S.push(e),S.length>50&&S.splice(0,1),p=c.max(S),q=c.min(S),a.botLog&&console.log([ka,"price-array:","length: "+S.length,"max: "+p,"min: "+q,"change-time-settings: "+(na(p,q)>102)].join("\n")),na(p,q)>102?C=.1:C!==a.timeUpdateAutoSettings&&(C=a.timeUpdateAutoSettings)),a.abruptChangeTrend&&(s=qa(l,500)),a.dangerPriceStop&&(v=ra(Q,109),x=sa(P,109)),a.dynamicOffsetOrders&&(y={current:qa(l,450),prev:qa(l,380),prev_2:qa(l,300)},z=m>=y.current||m>=y.prev||m>=y.prev_2),a.dynamicOffsetOrders&&z?(console.log("["+t()+"]: Dynamic market"),K=pa(y.current),L=1.3*K,M=1.5*a.stepBreakevenPercentConfig):(K=a.offsetMaxOneConfig,L=a.offsetMaxTwoConfig,M=a.stepBreakevenPercentConfig),I=qa(l,M),a.botLog&&(console.log(ka),console.log("current-spread:",(m+"")[m>I?"green":"white"]),console.log("spread-min-default:",I),console.log("trend-spread:",n),a.abruptChangeTrend&&console.log("immediate-spread:",s),console.log("trader-speed:",X),console.log("price-prev:",Q+" - "+P),console.log("price-prev2:",W.ask+" - "+W.bid),a.dangerPriceStop&&(console.log("danger-price-ask:",v,!D&&b>=v?"Attention!".red:""),console.log("danger-price-bid:",x,!D&&d<=x?"Attention!".red:"")),a.dynamicOffsetOrders&&(console.log("spread_1_450:",y.current,m>=y.current?"Attention!".red:""),console.log("spread_2_380:",y.prev,m>=y.prev?"Attention!".red:""),console.log("spread_3_300:",y.prev_2,m>=y.prev_2?"Attention!".red:""),console.log("dynamic-market:",z))),a.dangerPriceStop&&!D&&(b>=v||d<=x))return b>=v&&(G.buy=1),A=0,E=!0,N="DANGER PRICE: "+b+" - "+d+" | Bot Pause!",console.log("["+t()+"]: "+N),void o(N+"");O=2,ca=F>Math.round(aa/2)?L:K,a.botLog&&(console.log("offset-max-one:",(K+"")[K===a.offsetMaxOneConfig?"green":"yellow"]),console.log("offset-type-max:",ca),console.log(ka)),ba||(U="all",V=!1),D?ea=fa=ca:a.bbands?(ea=fa=ca,I=0,C=.1,ga=14,T.length>2*ga&&(i=k.BBANDS(T,20,a.bbandsDeviation),ha=i.middleband,ia=i.lowband,ja=i.highband,la=k.RSI(c.clone(T).reverse(),ga),oa=k.average(la).mean,ta=k.average(ha).mean,ua=k.average(ja).mean,va=k.average(ia).mean,xa=ua>e&&e>ta,ya=ta>e&&e>va,xa&&(U="sell"),ya&&(U="buy"),w=99>oa&&oa>68||1<oa&&oa<33,da=xa&&ya,a.botLog&&console.log(["BBANDS:","lowband: "+va,"middleband: "+ta,"highband: "+ua,"rsa: "+oa,"sell: "+xa,"buy: "+ya,"bot trade: "+w,"orders-calculation-brake: "+da,ka].join("\n")))):a.trendDefinition&&d>P&&b>Q&&m>n&&"normal"===X?(console.log("["+t()+"]: Trend: UP"),ea=O,fa=ca,ba||(U="buy",G.sell=1,A=0,a.abruptChangeTrend&&m>s&&(console.log("["+t()+"]: Spread Immediate"),V=!0,B=0))):a.trendDefinition&&d<P&&b<Q&&m>n&&"normal"===X?(console.log("["+t()+"]: Trend: DOWN"),ea=ca,fa=O,ba||(U="sell",G.buy=1,A=0,a.abruptChangeTrend&&m>s&&(console.log("["+t()+"]: Spread Immediate"),V=!0,B=0))):ea=fa=ca,W={ask:Q,bid:P},P=d,Q=b,R=e,J=qa(l),H={buy:wa(l,ea),sell:wa(l,fa),extra:wa(l)},Ma(),console.log("["+t()+"]: Update: "+U.toUpperCase()+" | "+b+" - "+d+" | "+e+" | "+r())},ya=function(a,b){var c,d;return c="name"===b?y.name:y.nameTwo,d=ma(a-ma(c,2),8),d>0?d:0},za=function(c,d){return D?b.parallel([function(b){return a.botLog&&console.log(ka+"\nПолучение цен"),l.getTicker(c).then(function(a){return b(null,{price:a[c].buy})}).catch(function(a){return b(a)})},function(d){return b.series([function(b){return a.botLog&&console.log(ka+"\nЗакрытие всех позиций"),G.all=1,$a(c,function(a){return b(null!=a?a:null)})},function(b){return a.botLog&&console.log(ka+"\nПолучение баланса"),Wa(a.tradeCurrency,function(c,d,e){return c?b(c):a.botTrade&&d<.1&&e<("btc"===a.tradeCurrency.nameTwo?.01:.1)?b({error:"Err: No money!"}):b(null,{balance:d,balanceTwo:e})})}],function(a,b){return a?d(a):d(null,{balance:b[1].balance,balanceTwo:b[1].balanceTwo})})}],function(b,c){var e,f,g,h,i,j,k,l,m,n;return b?d(b):(a.botLog&&console.log(ka+"\nРасчет депозита"),a.depositPercent=0<(e=a.depositPercent)&&e<=100?a.depositPercent:100,f=ma(c[1].balanceTwo/c[0].price+c[1].balance),g=ma(f*a.depositPercent/100),h=ma(c[1].balance*c[0].price+c[1].balanceTwo),i=ma(h*a.depositPercent/100),ma(c[1].balance)>=g&&ma(c[1].balanceTwo)>=i?(a.botLog&&console.log("type:",1),j=c[1].balance-g/2,k=c[1].balanceTwo-i/2):ma(c[1].balance)>=g&&ma(c[1].balanceTwo)<i?(a.botLog&&console.log("type:",2),j=c[1].balance-(i-c[1].balanceTwo)/c[0].price,k=0):ma(c[1].balance)<g&&ma(c[1].balanceTwo)>=i?(a.botLog&&console.log("type:",3),j=0,k=c[1].balanceTwo-(g-c[1].balance)*c[0].price):(a.botLog&&console.log("type:",4),j=0,k=0),a.botLog&&(l=na(j,c[1].balance),m=na(k,c[1].balanceTwo),console.log(["reserved-deposit:",a.tradeCurrency.name.toUpperCase(),l+"% / "+m+"%",a.tradeCurrency.nameTwo.toUpperCase()].join(" "))),y={name:j>0?j:0,nameTwo:k>0?k:0},a.countOrders?a.countOrders>=6||(a.countOrders=6):a.countOrders=g<=200?15:g<=500?18:g<=1e3?21:25,n=g>6?a.countOrders:Math.round(a.countOrders/2),aa=n*a.multiplierOrdersExtra,K=(e=ma(g/n))>_?e:_,a.botLog&&console.log([ka+"\nРасчет переменных","balance: "+ma(c[1].balance)+" "+a.tradeCurrency.name.toUpperCase(),"balance-two: "+ma(c[1].balanceTwo)+" "+ja[a.tradeCurrency.nameTwo],"deposit: "+f+" "+a.tradeCurrency.name.toUpperCase()+" или "+h+" "+a.tradeCurrency.nameTwo.toUpperCase(),"percent-deposit: "+a.depositPercent+" %","trade-deposit: "+g+" "+a.tradeCurrency.name.toUpperCase()+" | "+i+" "+a.tradeCurrency.nameTwo.toUpperCase(),"reserved-deposit: "+ma(y.name)+" "+a.tradeCurrency.name.toUpperCase()+" | "+ma(y.nameTwo)+" "+a.tradeCurrency.nameTwo.toUpperCase(),"count-orders: "+n,"size-static-order: "+K,ka].join("\n")),d(null))}):d(null)},n.on("message",function(d){var f,g,h,i,j,k,l,p,q,s,t;if(f=d.chat.id,a.myChatId||n.sendMessage(f,"Install your Telegram id: "+f),f===a.myChatId&&("Ордера"===d.text&&(g=function(){b.series([function(b){return Wa(a.tradeCurrency,function(a,c,d){return a?b(a):b(null,{balance:c,balanceTwo:d})})},function(b){return Va(a.tradeCurrency.pair,function(a,c){return a?b(a):b(null,{data:c})})}],function(b,d){var e,f,h,i,j,k,l,n,p,q,s;e=[r()+":",ka],f="Balance: "+(null!=(h=d[0])?h.balance.toFixed(3):void 0)+" "+a.tradeCurrency.name.toUpperCase()+" | "+ja[a.tradeCurrency.nameTwo]+(null!=(i=d[0])?i.balanceTwo.toFixed(3):void 0),b?0===b.success?(j=null!=(k=b.error)?k.split("send:")[1]:void 0,null!=j?(m.nonce=j,g()):(e.push(b.error+"\n"+ka+"\n"+f),o(e.join("\n")))):o(b):(l={},n=0,p=0,q={},Object.keys(d[1].data).forEach(function(b){var c,e,f;c=d[1].data[b].rate*+("1e"+Y),null!=q[c]?(++l[c],e=" | "+l[c],f=ma(ma(q[c].split("|")[1].trim())+ma(d[1].data[b].amount)),q[c]=d[1].data[b].type+" | "+f+" | "+ja[a.tradeCurrency.nameTwo]+d[1].data[b].rate+e):(l[c]=1,q[c]=d[1].data[b].type+" | "+ma(d[1].data[b].amount)+" | "+ja[a.tradeCurrency.nameTwo]+d[1].data[b].rate),n+=d[1].data[b].amount,p+=d[1].data[b].amount*d[1].data[b].rate}),e=c.concat(e,c.values(q)),e.push(ka+"\nCount: "+ma(n)+" | Sum: "+ja[a.tradeCurrency.nameTwo]+ma(p)+"\n"+f),s=e.join("\n"),o(s))})})(),"История"===d.text&&(h=function(){m.getTradeHistory({pair:a.tradeCurrency.pair,count:10}).then(function(b){var c;return c=[],Object.keys(b).forEach(function(d){c.push(b[d].type+" | "+b[d].amount.toFixed(3)+" | "+ja[a.tradeCurrency.nameTwo]+b[d].rate)}),c.push(r()+":\n"+ka),c.reverse(),o(c.join("\n"))}).catch(function(a){var b,c;0===a.success?(b=null!=(c=a.error)?c.split("send:")[1]:void 0,null!=b?(m.nonce=b,h()):o(a.error)):o(a)})})(),"Закрыть активные ордера"===d.text&&(i=function(){E=!0,G.all=1,setTimeout(function(){$a(a.tradeCurrency.pair,function(a){var b,c;a?0===a.success&&(b=null!=(c=a.error)?c.split("send:")[1]:void 0,null!=b?(m.nonce=b,i()):o(a.error)):o("Активные ордера закрыты на паре: "+r()),E=!1})},e("2s"))})(),"/config"===(null!=(j=d.text)?j.toLowerCase():void 0)&&(k=["Бот на паре "+r(),"TIME_UPDATE_AUTO_SETTINGS: "+C+" | время обновления авто настроек параметров (в мин)","DEPOSIT_LIMIT: "+a.depositPercent+" | процент использования депозита","NOTIFICATION_PAIR: "+a.notificationPair+" | пары для уведомления","NOTIFICATION_DEVIATION_PERCENT: "+a.notificationDeviation+" | процент отклонения от текущей цены чтобы сработало уведомление","COUNT_ORDERS: "+a.countOrders+" | количество ордеров","TIME_CLOSE_ORDERS: "+a.timeCloseOrdersDefault+" | сколько минут ждать перед закрытием неисполнившихся ордеров","TIME_CLOSE_ORDERS_INACTIVITY: "+a.timeCloseOrdersInactivity+" | закрытие после бездействия","OFFSET_MAX_ONE: "+a.offsetMaxOneConfig+" | отступ для 1 типа ордеров","OFFSET_MAX_TWO: "+a.offsetMaxTwoConfig+" | отступ для 2 типа ордеров","STEP_BREAKEVEN_PERCENT: "+a.stepBreakevenPercentConfig+" | процент отступа безубытка для торгов","DANGER_PRICE_STOP: "+a.dangerPriceStop+" | остановка бота при большом изменении цены","DYNAMIC_SETTINGS_TIME: "+a.dynamicSettingsTime+" | динамическое время обновления настроек","DYNAMIC_OFFSET_ORDERS: "+a.dynamicOffsetOrders+" | динамическое распределение ордеров","TREND_DEFINITION: "+a.trendDefinition+" | определение тренда","ABRUPT_CHANGE_TREND: "+a.abruptChangeTrend+" | быстрое изменение направления тренда","BBANDS: "+a.bbands+" | полосы Боллинджера","BBANDS_DEVIATION: "+a.bbandsDeviation+" | Отклонение","BBANDS_INTERVAL: "+a.bbandsInterval+" | Таймфрейм (в мин)"],o(k.join("\n\n"))),"/version"===(null!=(l=d.text)?l.toLowerCase():void 0)&&o("Версия бота: "+a.versionBot),a.masterWorker))return"/start"!==(p=null!=(q=d.text)?q.toLowerCase():void 0)&&"главное меню"!==p||(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Ордера"},{text:"Котировки"},{text:"История"}],[{text:"Контроль"},{text:"Нотис"},{text:"Торговля"}],[{text:"Закрыть активные ордера"}]],resize_keyboard:!0})},o("Выберите:",s)),"Котировки"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"USD"},{text:"BTC"},{text:"OTHER"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Валюта:",s)),"Торговля"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Сменить пару"},{text:"Тип"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"USD"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_usd"},{text:"PPC",callback_data:"ppc_usd"},{text:"NVC",callback_data:"nvc_usd"},{text:"LTC",callback_data:"ltc_usd"},{text:"BTC",callback_data:"btc_usd"}],[{text:"DSH",callback_data:"dsh_usd"},{text:"ETH",callback_data:"eth_usd"},{text:"EUR",callback_data:"eur_usd"},{text:"RUR",callback_data:"usd_rur"}]]})},o("Символ:",s)),"BTC"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"NMC",callback_data:"nmc_btc"},{text:"PPC",callback_data:"ppc_btc"},{text:"NVC",callback_data:"nvc_btc"},{text:"LTC",callback_data:"ltc_btc"}],[{text:"DSH",callback_data:"dsh_btc"},{text:"ETH",callback_data:"eth_btc"},{text:"RUR",callback_data:"btc_rur"},{text:"EUR",callback_data:"btc_eur"}]]})},o("Символ:",s)),"OTHER"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"ETH/LTC",callback_data:"eth_ltc"},{text:"ETH/EUR",callback_data:"eth_eur"},{text:"ETH/RUR",callback_data:"eth_rur"}],[{text:"LTC/RUR",callback_data:"ltc_rur"},{text:"LTC/EUR",callback_data:"ltc_eur"},{text:"EUR/RUR",callback_data:"eur_rur"}]]})},o("Пара:",s)),"Контроль"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Скорость"},{text:"Состояние"},{text:"Модули"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"Нотис"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({keyboard:[[{text:"Мониторинг"},{text:"Уведомление"}],[{text:"Круг"}],[{text:"Главное меню"}]],resize_keyboard:!0})},o("Выберите:",s)),"Мониторинг"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"monitoring start"},{text:"Стоп",callback_data:"monitoring stop"}]]})},t=ia.status?"Работает.":"Остановлен.",k=["Включает мониторинг возможных торговых пар. Уведомление раз в 5 минут.","Текущие состояние: "+t],o(k.join("\n"),s)),"Уведомление"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Старт",callback_data:"notification start"},{text:"Стоп",callback_data:"notification stop"}]]})},t=ha.status?"Работает.":"Остановлен.",k=["Включает уведомления о скачках курса.","Текущие состояние: "+t],o(k.join("\n"),s)),"Круг"===d.text&&Ta(),"Тип"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Only buy",callback_data:"type buy"},{text:"Only sell",callback_data:"type sell"},{text:"Buy & Sell",callback_data:"type all"}]]})},k=["Текущий тип торговли "+U.toUpperCase(),"Новый тип:"],o(k.join("\n"),s)),"Сменить пару"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"BTC/USD",callback_data:"trade btc_usd"},{text:"BTC/RUR",callback_data:"trade btc_rur"},{text:"BTC/EUR",callback_data:"trade btc_eur"}],[{text:"LTC/BTC",callback_data:"trade ltc_btc"},{text:"LTC/USD",callback_data:"trade ltc_usd"},{text:"LTC/RUR",callback_data:"trade ltc_rur"}],[{text:"LTC/EUR",callback_data:"trade ltc_eur"},{text:"NMC/BTC",callback_data:"trade nmc_btc"},{text:"NMC/USD",callback_data:"trade nmc_usd"}],[{text:"NVC/BTC",callback_data:"trade nvc_btc"},{text:"NVC/USD",callback_data:"trade nvc_usd"},{text:"PPC/BTC",callback_data:"trade ppc_btc"}],[{text:"PPC/USD",callback_data:"trade ppc_usd"},{text:"DSH/BTC",callback_data:"trade dsh_btc"},{text:"DSH/USD",callback_data:"trade dsh_usd"}],[{text:"ETH/BTC",callback_data:"trade eth_btc"},{text:"ETH/USD",callback_data:"trade eth_usd"},{text:"ETH/EUR",callback_data:"trade eth_eur"}],[{text:"ETH/LTC",callback_data:"trade eth_ltc"},{text:"ETH/RUR",callback_data:"trade eth_rur"},{text:"USD/RUR",callback_data:"trade usd_rur"}],[{text:"EUR/USD",callback_data:"trade eur_usd"},{text:"EUR/RUR",callback_data:"trade eur_rur"}]]})},k=["Текущая пара "+r(),"Новая торгая пара:"],o(k.join("\n"),s)),"Скорость"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Normal",callback_data:"speed normal"},{text:"Extra",callback_data:"speed extra"}]]})},k=["Влияет на плотность стека ордеров, размер спреда и время закрытия неиспользованных ордеров","Время действия "+la(C)+".","Текущая скорость: "+X].join("\n"),o(k,s)),"Состояние"===d.text&&(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Пауза",callback_data:"worker pause"},{text:"Продолжить",callback_data:"worker continued"}]]})},t=E?"Пауза":"Работает",o("Текущие состояние: "+t,s)),"Модули"===d.text?(s={parse_mode:"markdown",disable_web_page_preview:!1,reply_markup:JSON.stringify({inline_keyboard:[[{text:"Динам. время обновления "+(a.dynamicSettingsTime?"[Выкл]":"[Вкл]"),callback_data:"modules dynamic-settings-time"}],[{text:"Динам. распределение ордеров "+(a.dynamicOffsetOrders?"[Выкл]":"[Вкл]"),callback_data:"modules dynamic-offset-orders"}],[{text:"Определение тренда "+(a.trendDefinition?"[Выкл]":"[Вкл]"),callback_data:"modules trend-definition"}],[{text:"Контроль смены тренда "+(a.abruptChangeTrend?"[Выкл]":"[Вкл]"),callback_data:"modules abrupt-change-trend"}],[{text:"Стоп при большом изменении цены "+(a.dangerPriceStop?"[Выкл]":"[Вкл]"),callback_data:"modules danger-price-stop"}],[{text:"Включить все",callback_data:"modules all-modules-on"},{text:"Выключить все",callback_data:"modules all-modules-off"}],[{text:"Полосы Боллинджера "+(a.bbands?"[Выкл]":"[Вкл]"),callback_data:"modules bbands"}],[{text:"Вывод лога "+(a.botLog?"[Выкл]":"[Вкл]"),callback_data:"modules bot-log"}]]})},o("*Модули обновления настроек:*",s)):void 0}),n.on("callback_query",function(b){if(b.from.id===a.myChatId)return/trade (\w*_(usd|rur|eur|btc|ltc))/.test(b.data)?Aa(b.data.substr(6)):/speed (normal|extra)/.test(b.data)?Ca(b.data.substr(6)):/worker (continued|pause)/.test(b.data)?Da(b.data.substr(7)):/monitoring (start|stop)/.test(b.data)?Ga(b.data.substr(11)):/notification (start|stop)/.test(b.data)?Ha(b.data.substr(13)):/type (buy|sell|all)/.test(b.data)?Ba(b.data.substr(5)):/modules (\w*)/.test(b.data)?Ea(b.data.substr(8)):Fa(b.data)}),Aa=function(b){var c,d;a.masterWorker&&(o("Инициализировано изменение пары..."),clearTimeout(ca),E=!0,c=b.split("_")[0],d=b.split("_")[1],a.tradeCurrency.name===c&&a.tradeCurrency.nameTwo!==d?G.sell=1:a.tradeCurrency.name!==c&&a.tradeCurrency.nameTwo===d&&(G.buy=1),setTimeout(function(){$a(a.tradeCurrency.pair,function(){a.tradeCurrency={name:c,nameTwo:d,pair:[c,d].join("_")},D=!0,Qa(a.tradeCurrency.pair,function(a){var b;a?(console.log(("["+t()+"]: Ошибка получения данных с сервера!\n"+a.error).red),b=["Critical error: Ошибка получения данных с сервера!","Повторите попытку еще раз, иначе Trader Bot завершит работу через 20 секунд.","Ошибка: "+a.error].join("\n"),o(b),ca=setTimeout(function(){process.exit(0)},e("20s"))):(F=0,E=!1,o("Выполнено! Новая пара "+r()))})})},e("5s")))},Ba=function(b){a.masterWorker&&(U=b,ba="all"!==b,o("Выполнено! Новый тип "+U.toUpperCase()))},Ca=function(a){var b;Ma(a),b=["Режим "+a.toUpperCase()+" включен.","Пара: "+r()],B=u(),console.log(("\n["+t()+"]: "+b[0]+"\n").green),o(b.join(" "))},Da=function(a){var b;E="pause"===a,b=E?"Пауза":"Работает",o("Новое состояние: "+b+". Пара: "+r())},Ea=function(b){var c,d;/\all-modules/.test(b)?(c="all-modules-on"===b,a.dynamicSettingsTime=c,a.dynamicOffsetOrders=c,a.trendDefinition=c,a.abruptChangeTrend=c,a.dangerPriceStop=c,a.dynamicSettingsTime||(C=a.timeUpdateAutoSettings),o("Все модули "+(c?"включены":"выключены")+"!")):(d=b.replace(/\-./g,function(a,b,c){return a.replace("-","").toUpperCase()}),a[d]=!a[d],o(b.replace(/\-/g,"_").toUpperCase()+": "+a[d]))},Fa=function(b){a.masterWorker&&l.getTicker(b).then(function(c){var d,e,f,g,h,i,j,k,l,m,n;return d=Oa.pairs[b].decimal_places,e=c[b].last,f=c[b].sell,g=c[b].buy,h=ma(c[b].avg,d),i=ma(g-f,d),j=b.split("_")[1],k=qa(g,a.stepBreakevenPercentConfig,d),l=i>k?"✔":"✗",m=e>h?"↑":"↓",n=[b.replace("_","/").toUpperCase()+":","sell: "+ja[j]+f,"buy: "+ja[j]+g,"last: "+ja[j]+e,"avg: "+ja[j]+h+" | "+m,"spread:   "+i+" | "+(i/k*100-100).toFixed()+"%","required: "+k+" "+l],o(n.join("\n"))}).catch(function(a){o(a.error)})},Ga=function(b){var c;a.masterWorker&&(ia.status="start"===b,clearInterval(ia.interval),ia.status?(c="Работает",Ra(),ia.interval=setInterval(function(){Ra()},e("5m"))):c="Остановлен",o("Новое состояние: "+c))},Ha=function(b){var c;if(a.masterWorker){if(null==ea||!ea.length)return void o("Внимание! Конфиг для уведомлений не задан!");ha.status="start"===b,clearInterval(ha.interval),ha.status?(c="Работает",Sa()):c="Остановлен",o("Новое состояние: "+c)}},Ma=function(b){var c;null!=b&&(c=b),c||(c=F>aa?"extra":"normal"),F=0,"extra"===c?(Ia=H.extra,Ja=H.extra,La=J,Ka=60*a.timeCloseOrdersExtra):(Ia=H.buy,Ja=H.sell,La=I,Ka=60*a.timeCloseOrdersDefault),X=c},Na=0,Qa=function(a,b){return l.getInfo().then(function(c){return Oa=c,Pa=Object.keys(c.pairs),Y=c.pairs[a].decimal_places,_=c.pairs[a].min_amount,Z=c.pairs[a].min_price,$=c.pairs[a].fee,za(a,function(c){var d,e;return c?(d=null!=(e=c.error)?e.split("send:")[1]:void 0,null!=d?(m.nonce=d,Qa(a,b)):(Na++,Na>5?(Na=0,b(c)):Qa(a,b))):b(null)})}).catch(function(a){return b(a)})},Ra=function(){var c;c=Pa.join("-"),b.parallel([function(a){return l.getTicker(c).then(function(b){return a(null,b)}).catch(function(b){return a(b)})},function(a){return l.getTrades(c,{limit:2}).then(function(b){return a(null,b)}).catch(function(b){return a(b)})}],function(c,d){var g,h,i,j;if(c)return g="Error trading pairs available: "+c.error,o(g),void console.log(g.red);h=[],i=(new Date).getTime(),j=f.range(i-e("1m"),i),b.each(Pa,function(b,c){var e,f,g,i,k,l,m,n;return e=Oa.pairs[b].decimal_places,f=d[0][b].last,g=d[0][b].sell,i=d[0][b].buy,k=ma(d[0][b].avg,e),l=ma(i-g,e),m=qa(i,a.stepBreakevenPercentConfig,e),n=f>k?"↑":"↓",l>m&&j.contains(1e3*d[1][b][0].timestamp)&&j.contains(1e3*d[1][b][1].timestamp)?(h.push(b.replace("_","/").toUpperCase()+"\nprice: "+i+" - "+g+"\navg:   "+k+" | "+n+"\nspread:   "+l+" | "+(l/m*100-100).toFixed()+"%\nrequired: "+m+"\n"),c(null)):c(null)}),setTimeout(function(){h.length&&(h.push("Доступные пары для торгов:\n"),h.reverse(),o(h.join("\n")))},e("2s"))})},Sa=function(){var c,d;a.masterWorker&&null!=ea&&ea.length&&(c=ea.join("-"),d={},ha.interval=setInterval(function(){l.getTicker(c).then(function(c){return b.each(ea,function(b,f){var g,h,i,j,k,l,m,n,p,q,r;return a.tradeCurrency.pair===b?f(null):(g=Oa.pairs[b].decimal_places,h=c[b].sell,i=c[b].buy,j=c[b].last,k=ma(c[b].avg,g),l=ma(i-h,g),m=qa(h,a.notificationDeviation,g),l>m&&(n=b.split("_")[1],p=j<=h||j<=h+oa(3,g)?"down ↓":"up ↑",q=j>k?"↑":"↓",r=["Уведомление "+b.replace("_","/").toUpperCase()+":","directions: "+p,"sell: "+ja[n]+h,"buy: "+ja[n]+i,"last: "+ja[n]+j,"avg: "+ja[n]+k+" | "+q,"spread: "+l],d[b]||(d[b]=!0,o(r.join("\n")),setTimeout(function(){d[b]=!1,d.error=!1},e("15m")))),f(null))})}).catch(function(a){var b;if(b="Error notification price: "+a.error,console.log(b.red),!d.error)return o(b),d.error=!0})},e("2s")))},Ta=function(a,b){var c,d,e,f;null==a&&(a=.993),null==b&&(b=!1),c={},d={},e={},f={},Pa.forEach(function(a){var b;b=a.split(/\s*_\s*/),c[b[0]]?c[b[0]].push(b[1]):c[b[0]]=[b[1]]}),l.getTicker(Pa.join("-")).then(function(g){var h,i,j;if(Pa.forEach(function(a){d[a]=ta(1,g[a].buy)}),Pa.forEach(function(a){var b;b=a.split(/\s*_\s*/),c[b[0]].forEach(function(c){c!==b[1]&&(e[b[1]+"_"+b[0]+"_"+c]=ua(d[a],g[b[0]+"_"+c].sell))})}),Object.keys(e).forEach(function(b){var c,d;c=b.split(/\s*_\s*/),eb(c[0]+"_"+c[2],Pa)&&(d=ta(e[b],g[c[0]+"_"+c[2]].buy)),eb(c[2]+"_"+c[0],Pa)&&(d=ua(e[b],g[c[2]+"_"+c[0]].buy)),d>a&&(f[b+"_"+c[0]]=ma(d,5))}),h=["Проверка возможных вариантов перепродаж.","Показаны значения больше: "+a,"Значения меньше 1 убыточны:\n"],i=[],Object.keys(f).forEach(function(a){i.push([a.replace(/\_/g,"->"),f[a]])}),i.length?(j=i.sort(function(a,b){return b[1]-a[1]}),j.forEach(function(a){h.push(a.join(": "))})):h.push("Нет подходящих вариантов"),!b||i.length)return o(h.join("\n"))}).catch(function(a){return o("Error: "+a.error)})},Ua=function(a,b){return l.getTicker(a).then(function(c){var d,e,f,g;return d=c[a].last,e=c[a].sell,f=c[a].buy,g=ma(f-e,Y),N=La<=oa(2)?g>=La:g>La,b(null,{lastPrice:d,bidPrice:e,askPrice:f,spread:g})}).catch(function(a){return b(a)})},Va=function(a,b){return m.getActiveOrders(a).then(function(a){return b(null,a)}).catch(function(a){return b(a)})},Wa=function(a,b){return m.getInfo().then(function(c){return b(null,c.funds[a.name],c.funds[a.nameTwo])}).catch(function(a){return b(a)})},Xa=function(b,c){return N?Wa(b,function(b,d,e){return b?c(b):(d=ya(d,"name"),e=ya(e,"nameTwo"),"all"===U?d<_&&e<_?O<a.notCurrencyCycle&&O++:O>0&&(O=0):O=a.notCurrencyCycle,c(null,{balance:d,balanceTwo:e}))}):c(null)},Ya=function(a,c,d,e,f){var g;return c<_?f(null):da?f(null):(M=L=0,"all"===U||U===a?c>=K?(void 0!==g&&null!==g||(g=d),b.doWhilst(function(b){return V?("sell"===a&&(g-=Ja),"buy"===a&&(g+=Ia),c=ma(c/2),Za(a,g,c,e,b)):("buy"===a?(g-=Ia,c=ma(L/g)||c):(g+=Ja,c=M||c),c>K?Za(a,g,K,e,b):Za(a,g,ma(c/2),e,b))},function(){return c>ma(K/2)},function(a){return f(null!=a?a:null)})):Za(a,d,c,e,f):f(null))},Za=function(b,c,d,e,f){return d<_?f(null):(c=ma(c,Y),c>=Z||(c=Z),d=ma(d,8),m.trade({pair:e,type:b,rate:c,amount:d}).then(function(e){var g;return g="["+t()+"]: Open: "+b+" | rate: "+c+" | amount: "+d,"buy"===b?L=ya(e.funds[a.tradeCurrency.nameTwo],"nameTwo"):M=ya(e.funds[a.tradeCurrency.name],"name"),console.log("buy"===b?g.green:g.yellow),F++,f(null)}).catch(function(a){return console.log(("["+t()+"]: Error: "+b+" | rate: "+c+" | amount: "+d).red),f(a)}))},$a=function(a,c){return Va(a,function(a,d){var e,f;return A=u(),a?0===a.success&&null==(null!=(e=a.error)?e.split("send:")[1]:void 0)?(console.log(("["+t()+"] Cancel orders: "+a.error).yellow),c(null)):c(a):(f=Object.keys(d),b.eachSeries(f,function(a,b){return null!=G.buy&&"sell"===d[a].type?b(null):null!=G.sell&&"buy"===d[a].type?b(null):A-d[a].timestamp_created>(G.buy||G.sell||G.all||60)?_a(a,d[a].type,d[a].amount,d[a].rate,b):b(null)},function(a){return G={all:null,buy:null,sell:null},c(null!=a?a:null)}))})},_a=function(a,b,c,d,e){return m.cancelOrder({order_id:a}).then(function(){return console.log(("["+t()+"]: Close: "+b+" | rate: "+d+" | amount: "+c).cyan),F>0&&F--,e(null)}).catch(function(a){return e(a)})},ab=function(){ba||v(A,a.timeCloseOrdersInactivity)&&$a(a.tradeCurrency.pair,function(a){})},bb=function(){var a;v(z,10)&&(a="Unknown error: Worker Stop!",console.log(("["+t()+"]: "+a).red),db({error:a}))},cb=function(){z=u(),E?setTimeout(function(){cb()},e("30s")):b.series([function(b){return Ua(a.tradeCurrency.pair,b)},function(b){return Xa(a.tradeCurrency,b)}],function(c,d){var f;c?(f="object"==typeof c?c.error:c,console.log(("Error: "+f).red),db(c)):(D&&(xa(d[0].askPrice,d[0].bidPrice,d[0].lastPrice),D=!1),N?b.series([function(a){return C>0&&z-B>60*C&&xa(d[0].askPrice,d[0].bidPrice,d[0].lastPrice),a(null)},function(b){return z-A>Ka?$a(a.tradeCurrency.pair,b):b(null)},function(b){var c,e;return a.botTrade&&w?(c=ma(d[1].balanceTwo/d[0].askPrice),e=V?W.bid:d[0].bidPrice,Ya("buy",c,e,a.tradeCurrency.pair,b)):b(null)},function(b){var c;return a.botTrade&&w?(c=V?W.ask:d[0].askPrice,Ya("sell",d[1].balance,c,a.tradeCurrency.pair,b)):b(null)}],function(b){var c;b?(c="object"==typeof b?b.error:b,console.log(("ErrorTrader: "+c).red),db(b)):O===a.notCurrencyCycle?(clearTimeout(ga.eco),ga.eco=setTimeout(function(){cb()},e("2s"))):cb()}):(clearTimeout(ga.spread),ga.spread=setTimeout(function(){cb()},e(a.restartServerTime+"s"))))})},db=function(b){var c,d,f;c="restart using "+a.restartServerTime+" sec ...",console.log("["+t()+"]: "+c),d=null!=(f=b.error)?f.split("send:")[1]:void 0,null==d&&x!==b.error&&(x=b.error,a.emailS&&"production"===process.env.NODE_ENV&&q(s(b.error+"\n\n"+c),function(a,b){})),setTimeout(function(){console.log(("["+t()+"]: trader restart").bgGreen),null!=d&&(m.nonce=d),cb()},e(a.restartServerTime+"s"))},function(){a.myChatId&&(console.log("["+t()+"]: Trader Bot starting..."),Qa(a.tradeCurrency.pair,function(b){return b&&(console.log(("["+t()+"]: Error getting parameters from the server!\n"+b.error).red),process.exit(0)),cb(),a.botTrade&&setInterval(function(){ab(),bb()},e("5m")),setInterval(function(){va()},e(10*a.bbandsInterval+"s")),"production"===process.env.NODE_ENV&&o("Trader Bot started. Pair "+r()),console.log("["+t()+"]: Trader Bot started")}))}()}).call(this);